# Mini CRM

Простейшая CRM для распределения лидов между операторами.

# Запуск проекта

1. Создать виртуальное окружение:

python3 -m venv .venv
source .venv/bin/activate 

2. Установить зависимости:

pip install -r requirements.txt

3. Запустить сервер:

uvicorn main:app --reload

API будет доступно по адресу `http://127.0.0.1:8000`
документация Swagger — `http://127.0.0.1:8000/docs`

# Модель данных

Operator — оператор: имя, активность, максимальная загрузка (`max_load`).
Source — источник/бот.
OperatorSourceWeight — связь оператор + источник + вес (доля трафика).
Lead — внешний идентификатор лида (например, email или телефон).
Contact — обращение: связь лида с источником и назначенным оператором.

Связи: Operator ↔ OperatorSourceWeight ↔ Source; Lead ↔ Contact ↔ Source и Operator.

# Алгоритм распределения обращений

1. Определение лида:
   При создании контакта ищется существующий лид по `external_id`. Если не найден — создается новый.

2. Выбор операторов:
   Берутся операторы, назначенные на источник, фильтруются по активности и текущей нагрузке (`len(contacts) < max_load`).

3. Учет весов:
   Оператор выбирается случайно с вероятностью пропорционально его весу для источника (`weight / sum(weights)`).

4. Лимиты нагрузки:
   Если оператор превысил `max_load`, он не участвует в распределении.

5. Если нет подходящих операторов:
   Контакт создается без оператора (operator = null).